# Methods Overview

This document summarizes the modeling choices implemented in MINGO_DIGITAL_TWIN. It is intended
as a rigorous, code-aligned description of the physics-to-DAQ pipeline.

## Scope and assumptions
- Straight-line transport (no scattering or magnetic field effects).
- RPC response is parameterized (no microscopic drift or space-charge modeling).
- Readout coupling is modeled by geometric charge sharing across strips.
- Electronics are modeled as per-channel offsets, jitter, time-walk conversion, and thresholds.
- Event building is a formatting step that preserves channel ordering and timestamps.

## STEP 0: Parameter mesh (pre-pipeline)
STEP 0 constructs a `param_mesh.csv` by sampling:
- `cos_n` (angular distribution exponent) and `flux_cm2_min` (rate proxy).
- `eff_p1..eff_p4` (per-plane efficiencies).
- `z_p1..z_p4` (plane positions in mm), sourced from station config CSVs.

The mesh assigns step IDs:
- `step_1_id` by unique (cos_n, flux_cm2_min).
- `step_2_id` by unique (z_p1, z_p2, z_p3, z_p4).
- `step_3_id` by unique (eff_p1..eff_p4).
- `step_4_id..step_10_id` default to "001" unless extended.

## STEP 1: Muon generation
Random sampling:
- Positions:
  - `X_gen ~ U(-xlim_mm, +xlim_mm)`
  - `Y_gen ~ U(-ylim_mm, +ylim_mm)`
  - `Z_gen = z_plane_mm`
- Angles:
  - `Phi_gen ~ U(-pi, +pi)`
  - `Theta_gen = arccos(U^(1/(cos_n + 1)))`

This produces a cos^n(theta) zenith distribution. The thick-time tag is generated by
Poisson counts per second (rate derived from `flux_cm2_min` and active area), producing
integer-second labels in `T_thick_s`.

## STEP 2: Plane crossings
For each plane i with position z_i, the straight-line projection is:
```
dz_i = z_i + Z_gen
X_gen_i = X_gen + dz_i * tan(theta) * cos(phi)
Y_gen_i = Y_gen + dz_i * tan(theta) * sin(phi)
T_sum_i_ns = dz_i / (c_mm_per_ns * cos(theta))
```
Values outside the active bounds are set to NaN. Per-event times are shifted so the earliest
valid plane crossing is time 0.

## STEP 3: Gas ionization and avalanche
Per-plane efficiency is mapped to a Poisson ionization count:
```
lambda_i = -ln(1 - eff_i)
ions_i ~ Poisson(lambda_i)
```
Avalanche size is parameterized as:
```
avalanche_size_i = ions_i * exp(alpha * gap_mm) * LogNormal(mean=0, sigma=electron_sigma)
```
Avalanche centroid positions follow the plane crossing coordinates.

## STEP 4: Induction and strip coupling
Avalanche size sets an effective induction width. The width scaling is based on the modal
avalanche size (estimated from a histogram of the current plane):
```
width_scale = min((avalanche_size / mode_charge)^width_scale_exponent, width_scale_max)
scaled_width = avalanche_width_mm * width_scale
```
Charge sharing across strips is computed from the overlap between a uniform disk of radius
`scaled_width / 2` and each strip's Y boundaries. A binomial allocation of
`charge_share_points` samples is used to assign a fractional charge per strip.

Per-strip outputs:
- `Y_mea_i_sj`: charge on strip j in plane i (fraction * avalanche_size).
- `X_mea_i_sj`: avalanche x with Gaussian noise (`x_noise_mm`) for hit strips.
- `T_sum_meas_i_sj`: `T_sum_i_ns` with Gaussian noise (`time_sigma_ns`) for hit strips.

## STEP 5: Time/charge difference observables
The along-strip time difference is derived from X position:
```
T_diff = X_mea * (3 / (2 * c_mm_per_ns))
```
Charge imbalance is modeled as Gaussian noise:
```
q_diff ~ Normal(0, qdiff_frac * Y_mea)
```

## STEP 6: Front/back endpoints
Per-strip front/back quantities are derived algebraically:
```
T_front = T_sum_meas - T_diff
T_back  = T_sum_meas + T_diff
Q_front = Y_mea - q_diff
Q_back  = Y_mea + q_diff
```

## STEP 7: Cable/connector offsets
Fixed per-channel offsets are added to front/back times.

## STEP 8: FEE model (time-walk and threshold)
- Times receive Gaussian jitter (`t_fee_sigma_ns`).
- Q values are converted to time-walk units and offset per channel:
  `Q <- Q * q_to_time_factor + offset`.
- A threshold (`charge_threshold`) zeroes channels below threshold.

## STEP 9: Trigger selection
Per-plane activity is defined as any strip with `Q_front > 0` or `Q_back > 0`. The
trigger tag `tt_trigger` concatenates active planes (1..4). Events pass if any trigger
combination string is a subset of the active planes (order-independent).

## STEP 10: TDC smear and DAQ jitter
Active events receive:
- Gaussian TDC smear (`tdc_sigma_ns`) per channel.
- Uniform event-level jitter (`jitter_width_ns`) added to all active channels.

`daq_jitter_ns` records the per-event jitter value.

## STEP FINAL: Station .dat formatting
Events are serialized to ASCII station-style .dat lines. Each line encodes:
- Timestamp header (YYYY MM DD HH MM SS 1).
- 64 channel values ordered by plane [4,3,2,1], field [T_front, T_back, Q_front, Q_back],
  and strip [1..4].

If `T_thick_s` exists, it is used as a timestamp offset relative to a base date. Otherwise,
inter-arrival times follow an exponential distribution with mean 1/rate_hz.
