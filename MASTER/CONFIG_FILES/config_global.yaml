# DATAFLOW_v3 - Global Configuration
# Keep keys stable: many pipeline scripts read this file directly.

# -----------------------------------------------------------------------------
# Paths
# -----------------------------------------------------------------------------
home_path: "/home/mingo"
config_files_directory: "/home/mingo/DATAFLOW_v3/MASTER/CONFIG_FILES"

# -----------------------------------------------------------------------------
# STAGE_1 / EVENT_DATA / STEP_1 runner control (guide_raw_to_corrected.sh)
# -----------------------------------------------------------------------------
# This section lets the continuously running STEP_1 pipeline enable/disable
# specific (station, task) pairs without restarting the script.
#
# If `enabled: false`, guide_raw_to_corrected.sh behaves as usual.
# If `enabled: true`:
# - mode: "whitelist" -> run only the listed pairs.
# - mode: "blacklist" -> run everything except the listed pairs.
#
# Example: only run station 0 tasks 1-4
# event_data_step1_run_matrix:
#   enabled: true
#   mode: "whitelist"
#   stations:
#     "0": [1, 2, 3, 4]
#
# Example: run everything except station 2 task 4
# event_data_step1_run_matrix:
#   enabled: true
#   mode: "blacklist"
#   stations:
#     "2": [4]

event_data_step1_run_matrix:
  enabled: true
  mode: "whitelist"     # whitelist | blacklist
  default_tasks: []      # whitelist only: [] (none) | "all" | [1,2,3,4,5]
  idle_sleep_seconds: 300           # sleep when no pairs are enabled for this station list
  already_running_log_seconds: 300  # throttle "station already handled" cron log entries
  config_refresh_seconds: 60        # min seconds between config reloads
  stations:
    "0": [1] # , 2, 3, 4, 5]
    #"1": [1, 2, 3, 4, 5]
    #"2": [1, 2, 3, 4, 5]
    #"3": [1, 2, 3, 4, 5]
    #"4": [1, 2, 3, 4, 5]

# Resource limits for STEP_1 runner (guide_raw_to_corrected.sh)
event_data_resource_limits:
  mem_used_pct_max: 95          # percent
  swap_used_pct_max: 95         # percent
  swap_used_kb_max: 4194304     # 4 GB in kB
  cpu_used_pct_max: 95          # percent
  resource_backoff_seconds: 20  # sleep after a resource gate rejection

# -----------------------------------------------------------------------------
# STAGE_0 / REPROCESSING (prepare_reprocessing_metadata.sh)
# -----------------------------------------------------------------------------
prepare_reprocessing_metadata:
  remote_host: "backuplip"                   # SSH host with the remote raw listings.
  remote_user: "rpcuser"                     # SSH user to connect to the remote host.
  remote_directory_root: "/local/experiments/MINGOS"  # Base path that contains MINGO0{station} folders.
  date_range:
    start: 2025-12-01
    end: 2025-12-07

# Station-specific size and min-gap thresholds (used by prepare_reprocessing_metadata.sh)
min_size_mb_1: 4.0
max_size_mb_1: 8.0
min_gap_minutes_1: 5
max_gap_minutes_1: 120
use_processed_as_reject_list_1: true
unpack_anyway_station_1: true

min_size_mb_2: 2.2
max_size_mb_2: 3.7
min_gap_minutes_2: 5
max_gap_minutes_2: 140
use_processed_as_reject_list_2: true
unpack_anyway_station_2: true

min_size_mb_3: 2.2
max_size_mb_3: 3.3
min_gap_minutes_3: 5
max_gap_minutes_3: 40
use_processed_as_reject_list_3: true
unpack_anyway_station_3: true

min_size_mb_4: 4.5
max_size_mb_4: 6.1
min_gap_minutes_4: 5
max_gap_minutes_4: 140
use_processed_as_reject_list_4: true
unpack_anyway_station_4: true

# -----------------------------------------------------------------------------
# STAGE_1 / LAB_LOGS (log_bring_and_clean.sh)
# -----------------------------------------------------------------------------
create_new_csv: true

outlier_limits:
  rates_Asserted: [0, 60]
  rates_Edge: [0, 45]
  rates_Accepted: [0, 30]
  rates_Multiplexer1: [0, 400]
  rates_M2: [0, 400]
  rates_M3: [0, 400]
  rates_M4: [0, 400]
  rates_CM1: [0, 30]
  rates_CM2: [0, 30]
  rates_CM3: [0, 30]
  rates_CM4: [0, 30]
  sensors_ext_Temperature_ext: [0, 50]
  sensors_ext_RH_ext: [0, 100]
  sensors_ext_Pressure_ext: [500, 1300]
  sensors_int_Temperature_int: [0, 100]
  sensors_int_RH_int: [0, 100]
  sensors_int_Pressure_int: [500, 1300]
  odroid_DiskFill1: [0, 100]
  odroid_DiskFill2: [0, 100]
  odroid_DiskFillX: [0, 100000]
  flow_FlowRate1: [0, 1500]
  flow_FlowRate2: [0, 1500]
  flow_FlowRate3: [0, 1500]
  flow_FlowRate4: [0, 1500]
  hv_HVneg: [-0.1, 20]
  hv_HVpos: [-0.1, 20]

# -----------------------------------------------------------------------------
# STAGE_1 / COPERNICUS (copernicus.py)
# -----------------------------------------------------------------------------
test_mode: false
weeks_behind_requested: 1
max_weeks_allowed: 2
degree_apotema: 0.25

# -----------------------------------------------------------------------------
# STAGE_1 / EVENT_DATA - BRING (bring_data_and_config_files.sh)
# -----------------------------------------------------------------------------
logbook:
  sheet_id: "1ato36QkIXCxFkDT_LtAaLjPP7pvLcor-xZAP4fy00l0"
  gid_by_station:
    "1": 1331842924
    "2": 600987525
    "3": 376764978
    "4": 1268265225
    "5": 1331842924

# -----------------------------------------------------------------------------
# STAGE_1 / EVENT_DATA / STEP_1 (Tasks 1-5)
# RAW -> CLEAN -> CAL -> LIST -> FIT -> CORR
# -----------------------------------------------------------------------------

# Execution modes
crontab_execution: true
fast_mode: false
debug_mode: false
last_file_test: true
run_jupyter_notebook: false
# Default station when running STEP_1 tasks inside a notebook
jupyter_station_default_task_1: "2"
jupyter_station_default_task_2: "2"
jupyter_station_default_task_3: "2"
jupyter_station_default_task_4: "3"
jupyter_station_default_task_5: "2"

# Runtime toggles (Task 4/5)
self_trigger: false
timeseries_and_fits: false

# Fallback geometry when input-file configuration is missing
default_z_positions: [0, 150, 300, 450]

# Task 1 input-file scheduling priority by simulated geometry (mi00*.dat).
# When enabled, Task 1 will process matching z-vectors first.
task_1_z_position_priority:
  enabled: true
  simulated_only: true
  match_mode: "absolute"  # absolute | normalized | both
  source_csv: "/home/mingo/DATAFLOW_v3/MINGO_DIGITAL_TWIN/SIMULATED_DATA/step_final_simulation_params.csv"
  vectors_mm:
    - [30.0, 145.0, 290.0, 435.0]

# Reprocessing
try_to_use_reprocessing_table: false
complete_reanalysis: false

# Output behavior
force_replacement: true          # overwrite outputs even if an output already exists
article_format: false
presentation: false
presentation_plots: false
stratos_save: false

# Plots / saving (used by STEP_1 tasks + corrected_to_accumulated.py)
create_plots: false
create_essential_plots: false
save_plots: true
create_pdf: false
show_plots: false

# Debug plots (independent of create_plots)
create_debug_plots: false

save_rejected_rows: false
create_reject_plots: false

# Task-specific plot switches
create_plots_task_4: false
create_plots_task_4_station_0: false

# Limit rows (applied inside task scripts depending on mode)
limit: false
limit_number: 10000
limit_fast: false
limit_number_fast: 10000
limit_debug: true
limit_number_debug: 10000

# Calibration / figure outputs
save_calibrations: true
number_of_time_cal_figures: 3

# Core reconstruction toggles
calibrate_charge_ns_to_fc: true
validate_charge_pedestal_calibration: true
EXPECTED_COLUMNS_config: 71

# Residual diagnostic plots
residual_plots: false
residual_plots_fast: false
residual_plots_debug: false

# Charge front-back
charge_front_back: true
charge_front_back_fast: false
charge_front_back_debug: false

# Slewing correction
slewing_correction: false

# Time filtering
time_window_filtering: true

# Time calibration
time_calibration: true
time_calibration_fast: false
time_calibration_debug: false
old_timing_method: true
brute_force_analysis_time_calibration_path_finding: false

# Y reconstruction
# (keep in sync with the Task 1/2/3/4 scripts)
y_position_complex_method: false
uniform_y_method: true
uniform_weighted_method: false
y_new_method: true
blur_y: true

# Alternative fitter
alternative_fitting: true
alternative_iteration: false
number_of_det_executions: 2

# TimTrack
fixed_speed: false
res_ana_removing_planes: true
timtrack_iteration: true
timtrack_iteration_fast: false
timtrack_iteration_debug: false
number_of_TT_executions: 1

# -----------------------------------------------------------------------------
# STAGE_1 / EVENT_DATA / STEP_2 (corrected_to_accumulated.py)
# CORR -> ACC
# -----------------------------------------------------------------------------

# General settings
correct_angle: false
update_big_event_file: false
multiple_files: true
remove_outliers: true

# Particular analyses
side_calculations: false
eff_vs_charge: false
eff_vs_angle_and_pos: false
noise_vs_angle: false
noise_2d: false
charge_vs_angle: false
polya_fit: false
real_strip_case_study: false
multiplicity_calculations: false
crosstalk_probability: false
n_study_fit: false
topology_plots: false

# Multi-file / windowing
cluster_of_files: 0
time_window_in_hours: 10
time_tolerance_in_minutes: 10

# Limits / constants
three_plane_eff: false
crosstalk_limit: 1
streamer_limit: 100
q_e: 1.602e-4

# Smoothing / blurring
blurring_angular: true
blurring_sigma_angular: 2
blurring_xy: false
blurring_sigma_xy: 0.05

draw_angular_regions: true
time_to_min: false

# -----------------------------------------------------------------------------
# Note
# -----------------------------------------------------------------------------
# Many reconstruction thresholds are stored in:
#   /home/mingo/DATAFLOW_v3/MASTER/CONFIG_FILES/config_parameters.csv
